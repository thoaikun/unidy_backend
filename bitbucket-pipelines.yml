image: maven:3.8.4

pipelines:
  default:
    - step:
        name: Build and Deploy to Dev
        deployment: Develop
        script:
          - chmod 600 ./$SSH_PRIVATE_KEY

          - echo "kill current process"
          - ssh -i ./$SSH_PRIVATE_KEY -o StrictHostKeyChecking=no $EC2_INSTANCE "sudo fuser -k 8080/tcp"

          - echo "Building the Spring Boot project"
          - mvn clean package

          - echo "upload jar file to ec2"
          - scp -i ./$SSH_PRIVATE_KEY -o StrictHostKeyChecking=no target/*.jar $EC2_INSTANCE:/home/ubuntu/

          - echo "upload env file to ec2"
          - scp -i ./$SSH_PRIVATE_KEY -o StrictHostKeyChecking=no .env $EC2_INSTANCE:/home/ubuntu/

          - echo "SSHing into EC2 and running the JAR file"
          - ssh -i ./$SSH_PRIVATE_KEY -o StrictHostKeyChecking=no $EC2_INSTANCE "nohup java -jar /home/ubuntu/*.jar > /dev/null 2>&1 &"
